include required("/stdlib/jdk/24/openjdk.conf")
include required("https://raw.githubusercontent.com/hydraulic-software/conveyor/master/configs/jvm/extract-native-libraries.conf")

app {
  fsname = vaadin-conveyor
  display-name = "Vaadin Conveyor POC"
  rdns-name = "dev.nathanlively.vaadin-conveyor"

  # Get version from environment (set by GitHub Actions)
  version = ${?env.APP_VERSION}
  version = "1.0-dev"  # fallback for local development

  vcs-url = "https://github.com/LiveNathan/vaadin-conveyor"

  compression-level = low

  # Use wildcard to match any JAR version
  inputs += "target/vaadin-conveyor-*.jar"

  site {
    github {
      oauth-token = ${env.GITHUB_TOKEN}
      pages-branch = "gh-pages"
    }
  }

  # Enable console for debugging (remove for production)
  windows.console = true

  jvm {
    gui {
      main-class = "org.springframework.boot.loader.launch.JarLauncher"
      console = true
    }
    options += "-Xmx512m"
    options += "-Dserver.port=0"

    # Add --add-opens for Spring Boot reflection
    options += "--add-opens=java.base/java.lang=ALL-UNNAMED"
    options += "--add-opens=java.base/java.util=ALL-UNNAMED"
    options += "--add-opens=java.base/java.text=ALL-UNNAMED"
    options += "--add-opens=java.base/java.net=ALL-UNNAMED"
    options += "--add-opens=java.base/java.util.regex=ALL-UNNAMED"
    options += "--add-opens=java.base/java.lang.reflect=ALL-UNNAMED"
    options += "--add-opens=java.base/java.time=ALL-UNNAMED"
    options += "--add-opens=java.base/java.util.concurrent=ALL-UNNAMED"
    options += "--add-opens=java.management/sun.management=ALL-UNNAMED"

    # Extended module list for Spring Boot + Vaadin + Desktop
    modules += jdk.zipfs
    modules += java.management
    modules += java.management.rmi
    modules += java.naming
    modules += java.sql
    modules += java.security.jgss
    modules += java.desktop
    modules += java.instrument
    modules += java.compiler
    modules += jdk.unsupported
    modules += java.logging
    modules += java.prefs
    modules += java.xml
    modules += java.base
    modules += java.datatransfer
    modules += java.security.sasl
    modules += java.net.http
    modules += java.scripting
    modules += jdk.attach
    modules += jdk.management
  }

  machines = [ "mac", "windows.amd64", "linux.amd64.glibc", "linux.aarch64.glibc" ]
}

conveyor.compatibility-level = 19